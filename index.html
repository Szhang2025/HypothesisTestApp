<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hypothesis Testing App</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>

  <style>
    body {font-family: Arial, sans-serif; margin:20px; background:#f4f6f9;}
    .container {max-width:900px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    h1 {color:#2c3e50; margin-bottom:10px;}
    input, select, button, textarea {margin:8px 0; padding:8px; width:100%; font-size:16px; box-sizing:border-box;}
    textarea {white-space: pre-line; font-family: monospace;}
    button {background:#3498db; color:white; border:none; cursor:pointer; border-radius:5px;}
    button:hover {background:#2980b9;}
    .btn-rationale {background:#27ae60; font-size:14px; width:auto; padding:8px 16px; margin:10px 0;}
    .btn-rationale:hover {background:#1e8449;}
    table {width:100%; border-collapse:collapse; margin:15px 0;}
    th, td {border:1px solid #ddd; padding:8px; text-align:left;}
    th {background:#f2f2f2;}
    .result {margin-top:20px; padding:15px; border:1px solid #ddd; border-radius:5px; background:#f9f9f9;}
    .warn {background:#fff3cd; padding:10px; border:1px solid #ffeeba; border-radius:5px; margin-bottom:15px;}
    .error {color:red;}
    .success {color:green;}
    .toggle-btn {background:#7f8c8d; font-size:14px; width:auto; display:inline-block; margin:5px 0;}
    .toggle-btn:hover {background:#95a5a6;}
    .table-header {display:flex; justify-content:space-between; align-items:center;}
    .input-section {transition: all 0.3s ease;}
    .formula {background:#f8f9fa; padding:12px; border-left:4px solid #27ae60; margin:10px 0; font-family: monospace; font-size:1.1em;}
    .rationale-modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center;}
    .modal-content {background:white; padding:25px; border-radius:10px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.2);}
    .close-modal {float:right; font-size:24px; cursor:pointer; color:#aaa;}
    .close-modal:hover {color:#000;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Hypothesis Testing App</h1>

    <div id="inputSection" class="input-section">
      <label><strong>Upload CSV:</strong></label>
      <input type="file" id="csvFile" accept=".csv" />

      <label><strong>Or Paste CSV Here:</strong></label>
      <textarea id="csvText" rows="8" placeholder="id,score,group
1,85,A
2,92,A
3,78,B
4,,B
5,90,A
6,95,C
7,88,A
8,82,B
9,96,C"></textarea>

      <button onclick="loadData()">Load Data</button>
    </div>

    <div id="tableContainer"></div>

    <div id="controls" style="display:none;">
      <label><strong>Variable 1:</strong></label>
      <select id="var1"></select>

      <label><strong>Variable 2 (optional):</strong></label>
      <select id="var2"><option value="">None</option></select>

      <button onclick="runTest()">Run Test</button>
    </div>

    <div id="results"></div>
  </div>

  <!-- RATIONALE MODAL -->
  <div id="rationaleModal" class="rationale-modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeRationale()">×</span>
      <div id="rationaleContent">
        <p>Run a test to see its explanation.</p>
      </div>
    </div>
  </div>

  <script>
    let data = [];
    let headers = [];
    let lastTest = null;

    function loadData() {
      const file = document.getElementById('csvFile').files[0];
      const text = document.getElementById('csvText').value.trim();
      const parse = r => {
        if (r.errors.length) return alert('CSV error: ' + r.errors[0].message);
        parseCSV(r.data);
      };
      if (file) Papa.parse(file, { complete: parse });
      else if (text) Papa.parse(text, { complete: parse });
      else return alert('Upload a file or paste CSV.');
    }

    function parseCSV(rows) {
      if (rows.length < 2) return alert('Need header + at least one row.');
      headers = rows[0];
      data = rows.slice(1).map(r => {
        const o = {};
        headers.forEach((h, i) => {
          const val = r[i];
          o[h] = (val === '' || val === null || val === 'NA' || val === 'null') ? null : val;
        });
        return o;
      });

      document.getElementById('inputSection').style.display = 'none';
      displayTable();
      setupControls();
    }

    function displayTable() {
      let html = `
        <div class="table-header">
          <h3 style="margin:0;">Data Table</h3>
          <button class="toggle-btn" onclick="toggleTable()" id="toggleBtn">Hide Data Table</button>
        </div>
        <table><tr>`;
      headers.forEach(h => html += `<th>${h}</th>`);
      html += '</tr>';
      data.forEach(r => {
        html += '<tr>';
        headers.forEach(h => {
          const val = r[h] === null ? '<em style="color:#999;">(missing)</em>' : r[h];
          html += `<td>${val}</td>`;
        });
        html += '</tr>';
      });
      html += '</table>';
      document.getElementById('tableContainer').innerHTML = html;
    }

    function toggleTable() {
      const table = document.querySelector('#tableContainer table');
      const btn = document.getElementById('toggleBtn');
      if (table.style.display !== 'none') {
        table.style.display = 'none';
        btn.textContent = 'Show Data Table';
      } else {
        table.style.display = 'table';
        btn.textContent = 'Hide Data Table';
      }
    }

    function setupControls() {
      const s1 = document.getElementById('var1');
      const s2 = document.getElementById('var2');
      s1.innerHTML = ''; s2.innerHTML = '<option value="">None</option>';
      headers.forEach(h => {
        s1.innerHTML += `<option value="${h}">${h}</option>`;
        s2.innerHTML += `<option value="${h}">${h}</option>`;
      });
      document.getElementById('controls').style.display = 'block';
    }

    function getCompleteCases(vars) {
      return data.filter(row => vars.every(v => row[v] !== null));
    }

    function warnMissing(original, complete) {
      if (original > complete) {
        const d = document.createElement('div');
        d.className = 'warn';
        d.innerHTML = `<strong>Warning:</strong> ${original - complete} row(s) with missing values were <strong>excluded</strong>.`;
        document.getElementById('results').appendChild(d);
      }
    }

    function isQuantitative(col, data) {
      const nums = data.map(r => parseFloat(r[col])).filter(v => !isNaN(v));
      return nums.length >= 5 && new Set(nums).size > 10;
    }

    function isCategorical(col, data) {
      const vals = data.map(r => r[col]).filter(v => v !== null);
      return new Set(vals).size <= 10;
    }

    function runTest() {
      const v1 = document.getElementById('var1').value;
      const v2 = document.getElementById('var2').value;
      const res = document.getElementById('results');
      res.innerHTML = '';

      const selected = v2 ? [v1, v2] : [v1];
      const completeData = getCompleteCases(selected);
      const nComplete = completeData.length;
      const nOriginal = data.length;

      warnMissing(nOriginal, nComplete);

      if (nComplete === 0) {
        res.innerHTML = '<p class="error">No complete cases. Cannot run test.</p>';
        lastTest = null;
        return;
      }

      if (!v2) {
        if (isCategorical(v1, completeData)) {
          lastTest = { type: 'gof', col: v1 };
          chiSquareGOF(v1, completeData, res);
        } else if (isQuantitative(v1, completeData)) {
          lastTest = { type: 'one-sample-t', col: v1 };
          oneSampleTTest(v1, completeData, res);
        } else {
          res.innerHTML = '<p class="error">Variable type unclear.</p>';
          lastTest = null;
        }
        return;
      }

      const q1 = isQuantitative(v1, completeData);
      const q2 = isQuantitative(v2, completeData);
      const c1 = isCategorical(v1, completeData);
      const c2 = isCategorical(v2, completeData);

      if (c1 && c2) {
        lastTest = { type: 'chi-ind', col1: v1, col2: v2 };
        chiSquareIndependence(v1, v2, completeData, res);
      } else if ((q1 && c2) || (q2 && c1)) {
        const quant = q1 ? v1 : v2;
        const group = q1 ? v2 : v1;
        lastTest = { type: 'group', quant, group };
        groupComparison(quant, group, completeData, res);
      } else {
        res.innerHTML = '<p class="error">Invalid combination.</p>';
        lastTest = null;
      }
    }

    // SHOW RATIONALE BUTTON AFTER RESULTS
    function showRationaleButton() {
      if (!lastTest) return;
      const btn = document.createElement('button');
      btn.textContent = 'Show Rationale & Formula';
      btn.className = 'btn-rationale';
      btn.onclick = openRationale;
      document.getElementById('results').appendChild(btn);
    }

    function openRationale() {
      if (!lastTest) return;
      updateRationale(lastTest);
      document.getElementById('rationaleModal').style.display = 'flex';
    }

    function closeRationale() {
      document.getElementById('rationaleModal').style.display = 'none';
    }

    // DYNAMIC RATIONALE CONTENT
    function updateRationale(test) {
      const content = document.getElementById('rationaleContent');
      let html = '<h3>Method Explanation</h3>';

      if (test.type === 'one-sample-t') {
        html += `
          <h3>One-Sample t-Test</h3>
          <p><strong>H₀:</strong> μ = μ₀ (user-defined)</p>
          <p><strong>H₁:</strong> μ ≠ μ₀</p>
          <div class="formula">t = (x̄ - μ₀) / (s / √n)</div>
          <p>df = n - 1</p>
          <p><strong>p < 0.05 → Reject H₀</strong>: mean differs from μ₀.</p>
        `;
      } else if (test.type === 'group') {
        const groupCount = Object.keys(
          Object.fromEntries(
            Object.entries(
              data.reduce((g, r) => {
                const grp = r[test.group];
                if (grp !== null) g[grp] = (g[grp] || 0) + 1;
                return g;
              }, {})
            ).filter(([_, n]) => n >= 2)
          )
        ).length;

        if (groupCount === 2) {
          html += `
            <h3>Two-Sample t-Test (Welch)</h3>
            <p><strong>H₀:</strong> μ₁ = μ₂</p>
            <p><strong>H₁:</strong> μ₁ ≠ μ₂</p>
            <div class="formula">t = (x̄₁ - x̄₂) / √(s₁²/n₁ + s₂²/n₂)</div>
            <p>No equal variance assumed.</p>
            <p><strong>p < 0.05 → Reject H₀</strong>: groups differ.</p>
          `;
        } else {
          html += `
            <h3>One-Way ANOVA</h3>
            <p><strong>H₀:</strong> All means equal</p>
            <p><strong>H₁:</strong> At least one differs</p>
            <div class="formula">F = MST / MSE</div>
            <p>MST = between-group variance<br>MSE = within-group variance</p>
            <p><strong>p < 0.05 → Reject H₀</strong>: not all means equal.</p>
          `;
        }
      } else if (test.type === 'gof') {
        html += `
          <h3>Chi-Square Goodness-of-Fit</h3>
          <p><strong>H₀:</strong> Matches expected proportions</p>
          <p><strong>H₁:</strong> Does not match</p>
          <div class="formula">χ² = Σ (Oᵢ - Eᵢ)² / Eᵢ</div>
          <p>df = k - 1</p>
          <p><strong>p < 0.05 → Reject H₀</strong>: poor fit.</p>
        `;
      } else if (test.type === 'chi-ind') {
        html += `
          <h3>Chi-Square Independence</h3>
          <p><strong>H₀:</strong> Variables independent</p>
          <p><strong>H₁:</strong> Dependent</p>
          <div class="formula">χ² = Σ (Oᵢⱼ - Eᵢⱼ)² / Eᵢⱼ</div>
          <p>Eᵢⱼ = (Row × Col) / N</p>
          <p>df = (r-1)(c-1)</p>
          <p><strong>p < 0.05 → Reject H₀</strong>: association exists.</p>
        `;
      }

      content.innerHTML = html;
    }

    // === TEST FUNCTIONS (add showRationaleButton at end) ===
    function chiSquareGOF(col, data, div) {
      const counts = {};
      data.forEach(r => { const v = r[col]; counts[v] = (counts[v] || 0) + 1; });
      const cats = Object.keys(counts).sort();
      const n = data.length;

      const def = cats.map(() => (1/cats.length).toFixed(4)).join(',');
      const input = prompt(`Proportions (comma-separated):\n${cats.join(', ')}\nLeave blank for equal.`, def);
      if (input === null) return;

      let props = input.trim() ? input.split(',').map(parseFloat) : cats.map(() => 1/cats.length);
      if (props.length !== cats.length || props.some(p => isNaN(p) || p < 0)) return alert('Invalid proportions.');

      let sum = props.reduce((a,b) => a+b, 0);
      if (Math.abs(sum - 1) > 1e-6 && !confirm(`Sum = ${sum.toFixed(4)} ≠ 1. Scale?`)) return;
      if (sum !== 1) props = props.map(p => p/sum);

      const exp = props.map(p => p * n);
      let chi2 = 0;
      cats.forEach((c,i) => { if (exp[i] > 0) chi2 += Math.pow(counts[c] - exp[i], 2) / exp[i]; });
      const df = cats.length - 1;
      const p = df > 0 ? 1 - jStat.chisquare.cdf(chi2, df) : NaN;

      let tbl = '<table><tr><th>Category</th><th>Obs</th><th>Exp</th></tr>';
      cats.forEach((c,i) => tbl += `<tr><td>${c}</td><td>${counts[c]}</td><td>${exp[i].toFixed(2)}</td></tr>`);
      tbl += '</table>';

      div.innerHTML = `<div class="result">
        <h3>Chi-Square Goodness-of-Fit (n=${n})</h3>${tbl}
        <p><strong>χ² =</strong> ${chi2.toFixed(4)}, df=${df}, p=${isNaN(p) ? 'N/A' : p.toFixed(4)}</p>
        <p class="${p<0.05?'error':'success'}">${p<0.05?'Reject H₀':'Fail to reject H₀'}</p>
      </div>`;
      showRationaleButton();
    }

    function oneSampleTTest(col, data, div) {
      const nums = data.map(r => parseFloat(r[col])).filter(v => !isNaN(v));
      if (nums.length < 2) return div.innerHTML = '<p class="error">Need ≥2 valid numbers.</p>';

      const mean = ss.mean(nums);
      const sd = ss.standardDeviation(nums);
      const n = nums.length;
      const mu0 = prompt('Null mean (μ₀):', '0') || 0;
      const t = (mean - mu0) / (sd / Math.sqrt(n));
      const p = 2 * (1 - jStat.studentt.cdf(Math.abs(t), n-1));

      div.innerHTML = `<div class="result">
        <h3>One-Sample t-Test (n=${n})</h3>
        <p>Mean = ${mean.toFixed(3)}, SD = ${sd.toFixed(3)}</p>
        <p>H₀: μ = ${mu0}</p>
        <p><strong>t =</strong> ${t.toFixed(4)}, <strong>p =</strong> ${p.toFixed(4)}</p>
        <p class="${p<0.05?'error':'success'}">${p<0.05?'Reject H₀':'Fail to reject H₀'}</p>
      </div>`;
      showRationaleButton();
    }

    function chiSquareIndependence(c1, c2, data, div) {
      const table = {};
      data.forEach(r => {
        const a = r[c1], b = r[c2];
        if (!table[a]) table[a] = {};
        table[a][b] = (table[a][b] || 0) + 1;
      });

      const rows = Object.keys(table);
      const cols = new Set();
      rows.forEach(r => Object.keys(table[r]).forEach(c => cols.add(c)));
      const colNames = Array.from(cols);

      const obs = rows.map(r => colNames.map(c => table[r][c] || 0));
      const rowTot = obs.map(r => r.reduce((a,b) => a+b, 0));
      const colTot = colNames.map((_,j) => obs.reduce((s,r) => s+r[j], 0));
      const N = rowTot.reduce((a,b) => a+b, 0);

      let chi2 = 0;
      for (let i = 0; i < rows.length; i++) {
        for (let j = 0; j < colNames.length; j++) {
          const e = (rowTot[i] * colTot[j]) / N;
          if (e > 0) chi2 += Math.pow(obs[i][j] - e, 2) / e;
        }
      }
      const df = (rows.length - 1) * (colNames.length - 1);
      const p = 1 - jStat.chisquare.cdf(chi2, df);

      let cont = '<table><tr><th></th>' + colNames.map(c => `<th>${c}</th>`).join('') + '</tr>';
      rows.forEach((r,i) => cont += `<tr><td><strong>${r}</strong></td>` + obs[i].map(v => `<td>${v}</td>`).join('') + '</tr>');
      cont += '</table>';

      div.innerHTML = `<div class="result">
        <h3>Chi-Square Independence (n=${N})</h3>
        <p><strong>Contingency Table:</strong></p>${cont}
        <p><strong>χ² =</strong> ${chi2.toFixed(4)}, df=${df}, p=${p.toFixed(4)}</p>
        <p class="${p<0.05?'error':'success'}">${p<0.05?'Reject H₀: Dependent.':'Fail to reject H₀: Independent.'}</p>
      </div>`;
      showRationaleButton();
    }

    function groupComparison(quant, group, data, div) {
      const groups = {};
      data.forEach(r => {
        const g = r[group];
        const q = parseFloat(r[quant]);
        if (g !== null && !isNaN(q)) {
          if (!groups[g]) groups[g] = [];
          groups[g].push(q);
        }
      });

      const validGroups = Object.fromEntries(
        Object.entries(groups).filter(([_, vals]) => vals.length >= 2)
      );

      const list = Object.keys(validGroups);
      if (list.length < 2) {
        div.innerHTML = `<div class="result">
          <h3>Group Comparison</h3>
          <p class="error">Need ≥2 groups with n ≥ 2 each.</p>
          <p>Available after filtering:</p>
          ${Object.entries(groups).map(([g, v]) => `<p><strong>${g}:</strong> n=${v.length}</p>`).join('')}
        </div>`;
        lastTest = null;
        return;
      }

      const means = list.map(g => ss.mean(validGroups[g]));
      const sds = list.map(g => ss.standardDeviation(validGroups[g]));
      const ns = list.map(g => validGroups[g].length);

      let html = `<h3>${list.length === 2 ? 't-Test (Welch)' : 'One-Way ANOVA'}</h3>`;
      list.forEach((g,i) => html += `<p><strong>${g}:</strong> n=${ns[i]}, mean=${means[i].toFixed(3)}, sd=${sds[i].toFixed(3)}</p>`);

      if (list.length === 2) {
        const t = ss.tTestTwoSample(validGroups[list[0]], validGroups[list[1]]);
        const p = t === null ? NaN : t;
        if (isNaN(p)) {
          html += '<p class="error">t-test failed (check variance or sample size).</p>';
        } else {
          html += `<p><strong>t =</strong> ${t.toFixed(4)}, <strong>p =</strong> ${p.toFixed(4)}</p>`;
          html += `<p class="${p<0.05?'error':'success'}">${p<0.05?'Reject H₀: Means differ.':'Fail to reject H₀'}</p>`;
        }
      } else {
        try {
          const values = list.map(g => validGroups[g]);
          const anova = ss.anovaOneWay(values);
          if (anova && anova.pValue !== undefined) {
            html += `<p><strong>F =</strong> ${anova.F.toFixed(4)}, <strong>p =</strong> ${anova.pValue.toFixed(4)}</p>`;
            html += `<p class="${anova.pValue<0.05?'error':'success'}">${anova.pValue<0.05?'Reject H₀: At least one mean differs.':'Fail to reject H₀'}</p>`;
          } else {
            html += '<p class="error">ANOVA failed (insufficient variation).</p>';
          }
        } catch (e) {
          html += '<p class="error">ANOVA error: ' + e.message + '</p>';
        }
      }

      div.innerHTML = `<div class="result">${html}</div>`;
      showRationaleButton();
    }
  </script>
</body>
</html>
